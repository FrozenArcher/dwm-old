#!/usr/bin/env bash

if [ $(id -u) -ne 0 ]; then
    echo "Please run as root."
    exit 1
fi

# If src file is newer than dst file, or dst file
# doesn't exist, then install src to dst with given mode,
# and print a message.
# error: if $1
# args: $1: src file, $2: dst file, $3: mode, $4: message
update_file() {
    if [ ! -f $1 ]; then
        echo "error: update_file: source file $1 does not exist."
        exit 1
    fi
    if [ ! -f $2 ] || [ $(stat -c %Y $1) -gt $(stat -c %Y $2) ]; then
        if [[ $4 != "" ]]; then
            echo $4
        fi
        cp -avf $1 $2
        chmod -v $3 $2
    fi
}

if [ -f ./config.h ]; then
    echo "config.h should not exist."
    echo "config.h is generated by config.def.h"
    exit 1
fi

echo "==> copying config.h"
echo
cp -fv config.def.h config.h
echo

echo "==> compiling..."
echo
make
echo
echo "==> installing..."
echo
make install
echo

mkdir -p /usr/share/{{licenses,doc}/dwm,xsessions}

mkdir -p /usr/share/{,{licenses,doc}/dwm,xsessions}

update_file ../LICENSE /usr/share/licenses/dwm/LICENSE 644 "Updating LICENSE..."

update_file ../README.md /usr/share/doc/dwm/README.md 644 "Updating README.md..."

update_file ../dwm.desktop /usr/share/xsessions/dwm.desktop 644 "Updating dwm.desktop..."

update_file ../launch_dwm /usr/local/bin/launch_dwm 755 "Updating launch_dwm..."

echo "==> removing config.h"
echo
rm -v ./config.h
echo
echo "==> build finished."
