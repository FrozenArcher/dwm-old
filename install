#!/usr/bin/env bash

if [ $(id -u) -ne 0 ]; then
    echo "Please run as root."
    exit 1
fi

# If src file is newer than dst file, or dst file
# doesn't exist, then install src to dst with mode 644,
# and print a message.
# error: if $1
# args: $1: src file, $2: dst file, $3: msg
update_file() {
    if [ ! -f $1 ]; then
        echo "error: update_file: source file $1 does not exist."
        exit 1
    fi
    if [ ! -f $2 ] || [ $(stat -c %Y $1) -gt $(stat -c %Y $2) ]; then
        if [[ $3 != "" ]]; then
            echo $3
        fi
        cp -avf $1 $2
        chmod -v 644 $2
    fi
}

if [ -f ./config.h ]; then
    echo "config.h should not exist."
    echo "config.h is generated by config.def.h"
    exit 1
fi

echo "==> copying config.h"
echo
cp -fv config.def.h config.h
echo

echo "==> compiling..."
echo
make
echo
echo "==> installing..."
echo
make install
echo

# if [ ! -f /usr/share/licenses/dwm/LICENSE ]; then
#     echo "LICENSE file not installed. Installing..."
#     install -m644 -D LICENSE "/usr/share/licenses/dwm/LICENSE"
#     echo
# fi

# if [ ! -f /usr/share/doc/dwm/README.md ]; then
#     echo "README.md not installed. Installing..."
#     install -m644 -D README.md "/usr/share/doc/dwm/README.md"
#     echo
# fi

# if [ ! -f  /usr/share/xsessions/dwm.desktop ]; then
#     echo "dwm.desktop not installed. Installing..."
#     install -m644 -D ./dwm.desktop "/usr/share/xsessions/dwm.desktop"
#     echo
# fi

update_file ./LICENSE /usr/share/licenses/dwm/LICENSE "LICENSE file not installed. Installing..."

update_file ./README.md /usr/share/doc/dwm/README.md "README.md not installed. Installing..."

update_file ./dwm.desktop /usr/share/xsessions/dwm.desktop "dwm.desktop not installed. Installing..."

echo "==> removing config.h"
echo
rm -v ./config.h
echo
echo "==> build finished."
